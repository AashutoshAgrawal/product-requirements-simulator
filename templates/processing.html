{% extends "base.html" %}

{% block title %}Processing - Elicitron{% endblock %}

{% block content %}
<div class="processing-container">
    <h2>Processing Your Product Analysis</h2>
    <p class="status-message" id="status-message">Initializing pipeline...</p>
    
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-text" id="progress-text">0%</div>
    </div>
    
    <div class="stages-container">
        <div class="stage-progress" id="stage-1">
            <div class="stage-icon">1</div>
            <div class="stage-info">
                <h4>Agent Generation</h4>
                <p class="stage-status">Waiting...</p>
                <p class="stage-detail" id="stage-1-detail"></p>
            </div>
        </div>
        
        <div class="stage-progress" id="stage-2">
            <div class="stage-icon">2</div>
            <div class="stage-info">
                <h4>Experience Simulation</h4>
                <p class="stage-status">Waiting...</p>
                <p class="stage-detail" id="stage-2-detail"></p>
            </div>
        </div>
        
        <div class="stage-progress" id="stage-3">
            <div class="stage-icon">3</div>
            <div class="stage-info">
                <h4>Interview Simulation</h4>
                <p class="stage-status">Waiting...</p>
                <p class="stage-detail" id="stage-3-detail"></p>
            </div>
        </div>
        
        <div class="stage-progress" id="stage-4">
            <div class="stage-icon">4</div>
            <div class="stage-info">
                <h4>Latent Need Extraction</h4>
                <p class="stage-status">Waiting...</p>
                <p class="stage-detail" id="stage-4-detail"></p>
            </div>
        </div>
    </div>
    
    <div id="error-container" class="error-container" style="display: none;">
        <h3>Error</h3>
        <p id="error-text"></p>
        <a href="/" class="btn-secondary">Start Over</a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const jobId = '{{ job_id }}';
let pollInterval;

function updateProgress(data) {
    const statusMsg = document.getElementById('status-message');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    statusMsg.textContent = data.message || 'Processing...';
    
    // Update progress bar (0-4 stages = 0-100%)
    const progress = (data.stage / 4) * 100;
    progressFill.style.width = progress + '%';
    progressText.textContent = Math.round(progress) + '%';
    
    // Update stage cards
    for (let i = 1; i <= 4; i++) {
        const stageEl = document.getElementById(`stage-${i}`);
        const statusEl = stageEl.querySelector('.stage-status');
        const detailEl = document.getElementById(`stage-${i}-detail`);
        
        if (i < data.stage) {
            stageEl.classList.add('completed');
            statusEl.textContent = 'Completed';
        } else if (i === data.stage) {
            stageEl.classList.add('active');
            statusEl.textContent = 'In Progress...';
        } else {
            stageEl.classList.remove('active', 'completed');
            statusEl.textContent = 'Waiting...';
        }
    }
    
    // Update stage details
    if (data.stage >= 1 && data.agents_count) {
        document.getElementById('stage-1-detail').textContent = `${data.agents_count} agents generated`;
    }
    if (data.stage >= 2 && data.experiences_count) {
        document.getElementById('stage-2-detail').textContent = `${data.experiences_count} experiences simulated`;
    }
    if (data.stage >= 3 && data.interviews_count) {
        document.getElementById('stage-3-detail').textContent = `${data.interviews_count} interviews (${data.qa_pairs_count} Q&A pairs)`;
    }
    if (data.stage >= 4 && data.total_needs) {
        document.getElementById('stage-4-detail').textContent = `${data.total_needs} needs extracted`;
    }
    
    // Check if completed
    if (data.status === 'completed') {
        clearInterval(pollInterval);
        setTimeout(() => {
            window.location.href = `/results/${jobId}`;
        }, 1500);
    }
    
    // Check for errors
    if (data.status === 'error') {
        clearInterval(pollInterval);
        const errorContainer = document.getElementById('error-container');
        const errorText = document.getElementById('error-text');
        errorText.textContent = data.error || 'An error occurred';
        errorContainer.style.display = 'block';
    }
}

function pollStatus() {
    fetch(`/api/status/${jobId}`)
        .then(response => response.json())
        .then(data => {
            updateProgress(data);
        })
        .catch(error => {
            console.error('Error polling status:', error);
        });
}

// Start polling
pollInterval = setInterval(pollStatus, 2000);
pollStatus(); // Initial poll
</script>
{% endblock %}

